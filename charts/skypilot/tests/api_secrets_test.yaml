# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: api_secrets_test
templates:
  - templates/api-secrets.yaml
tests:
  - it: should create slurm-config secret when config is provided
    set:
      slurmCredentials.config: |
        Host mycluster
            HostName login.mycluster.myorg.com
            User myuser
            IdentityFile ~/.ssh/id_rsa
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-slurm-config
      - matchRegex:
          path: stringData.config
          pattern: "Host mycluster"

  - it: should not create slurm-config secret when config is null
    asserts:
      - hasDocuments:
          count: 0

  - it: should create both secrets when sshNodePools and slurmCredentials are provided
    set:
      apiService.sshNodePools: |
        node_pools:
          - name: test
      slurmCredentials.config: |
        Host mycluster
            HostName login.mycluster.myorg.com
            User myuser
            IdentityFile ~/.ssh/id_rsa
    asserts:
      - hasDocuments:
          count: 2
